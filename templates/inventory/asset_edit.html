{% extends "base.html" %}

{% block title %}Edit {{ asset.name }} | IT Asset Tracker{% endblock %}

{% block content %}
  <div class="mb-4 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold">Edit asset: {{ asset.name|default:"(no hostname)" }}</h1>
      <p class="text-sm text-slate-600">Asset, OS entries and network interfaces.</p>
    </div>
    <a href="{% url 'inventory:asset-detail' asset.id %}" class="inline-flex h-9 items-center rounded border border-slate-300 px-3 text-sm hover:bg-slate-100">Back to detail</a>
  </div>

  <div class="mb-4 grid grid-cols-1 gap-4 lg:grid-cols-2">
    <section class="rounded-lg border border-slate-200 bg-white p-4">
      <form method="post">
        {% csrf_token %}
        <h2 class="mb-3 text-lg font-medium">Asset</h2>
        <div class="space-y-2">
          {% for field in asset_form %}
            <div>
              <label for="{{ field.id_for_label }}" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">{{ field.label }}</label>
              {{ field }}
              {% if field.errors %}
                <p class="mt-1 text-xs text-red-600">{{ field.errors|join:", " }}</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <div class="mt-3">
          <button type="submit" class="inline-flex h-9 items-center rounded bg-slate-900 px-4 text-sm font-medium text-white hover:bg-slate-700">Save asset</button>
        </div>
      </form>
    </section>

    <section class="rounded-lg border border-slate-200 bg-white p-4">
      <div class="mb-3 flex items-center justify-between">
        <h2 class="text-lg font-medium">OS Features</h2>
        <span class="text-xs text-slate-500">Asset může mít více OS</span>
      </div>

      <div class="space-y-2">
        {% for row in os_row_forms %}
          <form method="post" action="{% url 'inventory:asset-os-update' asset.id row.record.id %}" class="rounded border border-slate-200 p-3">
            {% csrf_token %}
            <div class="grid grid-cols-1 gap-2 md:grid-cols-3">
              <div>
                <label for="{{ row.form.family.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">OS</label>
                {{ row.form.family }}
              </div>
              <div>
                <label for="{{ row.form.version.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Version</label>
                {{ row.form.version }}
              </div>
              <div>
                <label for="{{ row.form.patch_level.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Patch</label>
                {{ row.form.patch_level }}
              </div>
              <div>
                <label for="{{ row.form.installed_on.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Installed</label>
                {{ row.form.installed_on }}
              </div>
              <div>
                <label for="{{ row.form.support_state.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Support</label>
                {{ row.form.support_state }}
              </div>
              <div class="flex items-end">
                <label class="flex h-9 items-center gap-2 rounded border border-slate-300 bg-white px-3 text-sm text-slate-700">
                  {{ row.form.auto_updates_enabled }}
                  Auto updates
                </label>
              </div>
            </div>
            <div class="mt-2 flex items-center gap-2">
              <button type="submit" name="action" value="save" class="inline-flex h-8 items-center rounded border border-slate-300 px-3 text-xs hover:bg-slate-100">Save</button>
              <button type="submit" name="action" value="delete" class="inline-flex h-8 items-center rounded border border-amber-300 bg-amber-50 px-3 text-xs text-amber-800 hover:bg-amber-100">Remove</button>
            </div>
          </form>
        {% empty %}
          <p class="text-sm text-slate-500">No OS entries yet.</p>
        {% endfor %}
      </div>

      <details class="mt-3 rounded-lg border border-blue-200 bg-blue-50/40" {% if os_form.errors %}open{% endif %}>
        <summary class="cursor-pointer select-none px-3 py-2 text-sm font-semibold text-blue-900">Add OS</summary>
        <form method="post" action="{% url 'inventory:asset-os-add' asset.id %}" class="border-t border-blue-200 px-3 py-3">
          {% csrf_token %}
          <div class="grid grid-cols-1 gap-2 md:grid-cols-3">
            <div>
              <label for="{{ os_form.family.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">OS</label>
              {{ os_form.family }}
              {% if os_form.family.errors %}<p class="mt-1 text-xs text-red-600">{{ os_form.family.errors|join:", " }}</p>{% endif %}
            </div>
            <div>
              <label for="{{ os_form.version.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Version</label>
              {{ os_form.version }}
              {% if os_form.version.errors %}<p class="mt-1 text-xs text-red-600">{{ os_form.version.errors|join:", " }}</p>{% endif %}
            </div>
            <div>
              <label for="{{ os_form.patch_level.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Patch</label>
              {{ os_form.patch_level }}
              {% if os_form.patch_level.errors %}<p class="mt-1 text-xs text-red-600">{{ os_form.patch_level.errors|join:", " }}</p>{% endif %}
            </div>
            <div>
              <label for="{{ os_form.installed_on.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Installed</label>
              {{ os_form.installed_on }}
            </div>
            <div>
              <label for="{{ os_form.support_state.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Support</label>
              {{ os_form.support_state }}
            </div>
            <div class="flex items-end">
              <label class="flex h-9 items-center gap-2 rounded border border-slate-300 bg-white px-3 text-sm text-slate-700">
                {{ os_form.auto_updates_enabled }}
                Auto updates
              </label>
            </div>
          </div>
          <div class="mt-2">
            <button type="submit" class="inline-flex h-9 items-center rounded border border-slate-300 bg-white px-3 text-sm hover:bg-slate-100">Add OS entry</button>
          </div>
        </form>
      </details>
    </section>
  </div>

  <section class="rounded-lg border border-slate-200 bg-white p-4">
    <h2 class="mb-3 text-lg font-medium">Ports and Interfaces</h2>
    <div class="space-y-3">
      {% for item in ports_tree %}
        <article class="rounded border border-slate-200 p-3">
          <form method="post" action="{% url 'inventory:asset-port-update' asset.id item.port.id %}" class="mb-3 grid grid-cols-1 gap-2 rounded border border-slate-200 bg-slate-50 p-3 md:grid-cols-[1fr_170px_1fr_auto]">
            {% csrf_token %}
            <div>
              <label for="{{ item.port_edit_form.name.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Port name</label>
              {{ item.port_edit_form.name }}
            </div>
            <div>
              <label for="{{ item.port_edit_form.port_kind.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Kind</label>
              {{ item.port_edit_form.port_kind }}
            </div>
            <div>
              <label for="{{ item.port_edit_form.notes.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Notes</label>
              {{ item.port_edit_form.notes }}
            </div>
            <div class="flex items-end gap-2">
              <button type="submit" name="action" value="save" class="inline-flex h-9 items-center rounded border border-slate-300 px-3 text-xs hover:bg-slate-100">Save</button>
              <button type="submit" name="action" value="deactivate" class="inline-flex h-9 items-center rounded border border-amber-300 bg-amber-50 px-3 text-xs text-amber-800 hover:bg-amber-100">Deactivate</button>
            </div>
          </form>

          <div class="space-y-2">
            {% for row in item.interface_rows %}
              <form method="post" action="{% url 'inventory:asset-port-interface-update' asset.id item.port.id row.interface.id %}" class="grid grid-cols-1 gap-2 rounded border border-slate-200 p-3 md:grid-cols-[1fr_1fr_1fr_auto]">
                {% csrf_token %}
                <div>
                  <label for="{{ row.form.identifier.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Identifier</label>
                  {{ row.form.identifier }}
                </div>
                <div>
                  <label for="{{ row.form.mac_address.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">MAC</label>
                  {{ row.form.mac_address }}
                </div>
                <div>
                  <label for="{{ row.form.notes.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Notes</label>
                  {{ row.form.notes }}
                </div>
                <div class="flex items-end gap-2">
                  <button type="submit" name="action" value="save" class="inline-flex h-9 items-center rounded border border-slate-300 px-3 text-xs hover:bg-slate-100">Save</button>
                  <button type="submit" name="action" value="deactivate" class="inline-flex h-9 items-center rounded border border-amber-300 bg-amber-50 px-3 text-xs text-amber-800 hover:bg-amber-100">Deactivate</button>
                </div>
                <div class="md:col-span-4 rounded border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-700">
                  {% for ip in row.interface.ip_addresses.all %}
                    <span class="mr-2 inline-block">{{ ip.address }} ({{ ip.network.name }}){% if not ip.active %} - inactive{% endif %}</span>
                  {% empty %}
                    -
                  {% endfor %}
                </div>
              </form>
            {% empty %}
              <p class="text-sm text-slate-500">No interfaces under this port.</p>
            {% endfor %}
          </div>

          <details class="mt-3 rounded-lg border border-violet-200 bg-violet-50/40">
            <summary class="cursor-pointer select-none px-3 py-2 text-sm font-semibold text-violet-900">Add interface to {{ item.port.name }}</summary>
            <form method="post" action="{% url 'inventory:asset-port-interface-add' asset.id item.port.id %}" class="grid grid-cols-1 gap-2 border-t border-violet-200 bg-white p-3 md:grid-cols-[1fr_1fr_1fr_auto]">
              {% csrf_token %}
              <div>
                <label for="{{ item.interface_form.identifier.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Identifier</label>
                {{ item.interface_form.identifier }}
              </div>
              <div>
                <label for="{{ item.interface_form.mac_address.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">MAC</label>
                {{ item.interface_form.mac_address }}
              </div>
              <div>
                <label for="{{ item.interface_form.notes.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Notes</label>
                {{ item.interface_form.notes }}
              </div>
              <div class="flex items-end">
                <button type="submit" class="inline-flex h-9 items-center rounded border border-slate-300 px-3 text-sm hover:bg-slate-100">Add interface</button>
              </div>
            </form>
          </details>
        </article>
      {% empty %}
        <p class="text-sm text-slate-500">No ports defined yet.</p>
      {% endfor %}
    </div>

    {% if unassigned_interfaces %}
      <div class="mt-3 rounded border border-amber-200 bg-amber-50 p-3 text-sm text-amber-800">
        <p class="font-semibold">Unassigned interfaces</p>
        <ul class="mt-1 list-disc pl-5">
          {% for interface in unassigned_interfaces %}
            <li>{{ interface.identifier }} ({{ interface.mac_address|default:"no MAC" }})</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div class="mt-3 flex items-center gap-2">
      <button type="button" onclick="document.getElementById('quick-port-modal').showModal()" class="inline-flex h-9 items-center rounded bg-blue-600 px-4 text-sm font-medium text-white hover:bg-blue-500">Quick add Port + Interface</button>
    </div>

    <dialog id="quick-port-modal" class="rounded-lg border border-slate-200 bg-white p-0 shadow-xl backdrop:bg-slate-900/50">
      <div class="w-[28rem] p-5">
        <div class="mb-3 flex items-center justify-between">
          <h3 class="text-lg font-medium">Quick add Port + Interface</h3>
          <button type="button" onclick="document.getElementById('quick-port-modal').close()" class="text-slate-400 hover:text-slate-600">&times;</button>
        </div>
        <form method="post" action="{% url 'inventory:asset-quick-port-interface' asset.id %}">
          {% csrf_token %}
          <div class="space-y-2">
            <div>
              <label for="{{ quick_port_interface_form.interface_name.id_for_label }}" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">Interface name</label>
              {{ quick_port_interface_form.interface_name }}
            </div>
            <div>
              <label for="{{ quick_port_interface_form.port_kind.id_for_label }}" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">Port kind</label>
              {{ quick_port_interface_form.port_kind }}
            </div>
            <div>
              <label for="{{ quick_port_interface_form.description.id_for_label }}" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">Description</label>
              {{ quick_port_interface_form.description }}
            </div>
            <div>
              <label for="{{ quick_port_interface_form.mac_address.id_for_label }}" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">MAC address</label>
              {{ quick_port_interface_form.mac_address }}
            </div>
          </div>
          <div class="mt-4 flex items-center justify-end gap-2">
            <button type="button" onclick="document.getElementById('quick-port-modal').close()" class="inline-flex h-9 items-center rounded border border-slate-300 px-3 text-sm hover:bg-slate-100">Cancel</button>
            <button type="submit" class="inline-flex h-9 items-center rounded bg-slate-900 px-4 text-sm font-medium text-white hover:bg-slate-700">Create</button>
          </div>
        </form>
      </div>
    </dialog>

    <details class="mt-3 rounded-lg border border-emerald-200 bg-emerald-50/40">
      <summary class="cursor-pointer select-none px-4 py-3 text-sm font-semibold text-emerald-900">Add Port</summary>
      <section class="border-t border-emerald-200 bg-white p-4">
        <form method="post" action="{% url 'inventory:asset-port-add' asset.id %}" class="grid grid-cols-1 gap-2 md:grid-cols-[1fr_180px_1fr_auto]">
          {% csrf_token %}
          <div>
            <label for="{{ port_form.name.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Name</label>
            {{ port_form.name }}
          </div>
          <div>
            <label for="{{ port_form.port_kind.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Kind</label>
            {{ port_form.port_kind }}
          </div>
          <div>
            <label for="{{ port_form.notes.id_for_label }}" class="mb-1 block text-xs font-semibold text-slate-600">Notes</label>
            {{ port_form.notes }}
          </div>
          <div class="flex items-end">
            <button type="submit" class="inline-flex h-9 items-center rounded border border-slate-300 px-3 text-sm hover:bg-slate-100">Create port</button>
          </div>
        </form>
      </section>
    </details>
  </section>
{% endblock %}
