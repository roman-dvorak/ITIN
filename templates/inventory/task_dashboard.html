{% extends "base.html" %}

{% block title %}Task Dashboard{% endblock %}

{% block content %}
  <div class="mb-6">
    <h1 class="text-2xl font-semibold">Task Dashboard</h1>
    <p class="text-sm text-slate-600">Run background tasks and view history</p>
  </div>

  <section class="mb-6 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
    {% for task in tasks %}
      <article class="rounded-lg border border-slate-200 bg-white p-4">
        <h3 class="font-medium text-slate-900">{{ task.name }}</h3>
        <p class="mt-1 text-sm text-slate-600">{{ task.description }}</p>
        <form method="post" action="{% url 'inventory:task-trigger' %}" class="mt-3">
          {% csrf_token %}
          <input type="hidden" name="task_name" value="{{ task.name }}">
          {% for param_name, param_type in task.params.items %}
            {% if param_type == "bool" %}
              <label class="mt-1 flex items-center gap-2 text-sm text-slate-700">
                <input type="checkbox" name="{{ param_name }}" class="rounded border-slate-300">
                {{ param_name }}
              </label>
            {% endif %}
          {% endfor %}
          <button type="submit" class="mt-3 rounded bg-slate-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-slate-700">Run</button>
        </form>
      </article>
    {% empty %}
      <p class="text-sm text-slate-500">No registered tasks.</p>
    {% endfor %}
  </section>

  <section class="rounded-lg border border-slate-200 bg-white p-4">
    <h2 class="mb-3 text-lg font-medium">Recent Runs</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-3 py-2 text-left font-medium text-slate-600">ID</th>
            <th class="px-3 py-2 text-left font-medium text-slate-600">Task</th>
            <th class="px-3 py-2 text-left font-medium text-slate-600">Status</th>
            <th class="px-3 py-2 text-left font-medium text-slate-600">Started</th>
            <th class="px-3 py-2 text-left font-medium text-slate-600">Finished</th>
            <th class="px-3 py-2 text-left font-medium text-slate-600">Triggered by</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          {% for run in recent_runs %}
            <tr>
              <td class="px-3 py-2">
                <a href="{% url 'inventory:task-detail' run.pk %}" class="font-medium text-blue-700 hover:underline">#{{ run.pk }}</a>
              </td>
              <td class="px-3 py-2">{{ run.task_name }}</td>
              <td class="px-3 py-2">
                <span class="rounded px-2 py-0.5 text-xs font-medium
                  {% if run.status == 'SUCCESS' %}bg-emerald-100 text-emerald-800
                  {% elif run.status == 'RUNNING' %}bg-blue-100 text-blue-800
                  {% elif run.status == 'FAILED' %}bg-red-100 text-red-800
                  {% else %}bg-slate-100 text-slate-700{% endif %}">{{ run.get_status_display }}</span>
              </td>
              <td class="px-3 py-2">{{ run.started_at|date:"Y-m-d H:i:s" }}</td>
              <td class="px-3 py-2">{% if run.finished_at %}{{ run.finished_at|date:"Y-m-d H:i:s" }}{% else %}-{% endif %}</td>
              <td class="px-3 py-2">{% if run.triggered_by %}{{ run.triggered_by.email }}{% else %}-{% endif %}</td>
            </tr>
          {% empty %}
            <tr>
              <td class="px-3 py-2 text-slate-500" colspan="6">No task runs yet.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}
